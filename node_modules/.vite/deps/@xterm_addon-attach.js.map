{
  "version": 3,
  "sources": ["../../@xterm/addon-attach/src/AttachAddon.ts"],
  "sourcesContent": ["/**\n * Copyright (c) 2014, 2019 The xterm.js authors. All rights reserved.\n * @license MIT\n *\n * Implements the attach method, that attaches the terminal to a WebSocket stream.\n */\n\nimport type { Terminal, IDisposable, ITerminalAddon } from '@xterm/xterm';\nimport type { AttachAddon as IAttachApi } from '@xterm/addon-attach';\n\ninterface IAttachOptions {\n  bidirectional?: boolean;\n}\n\nexport class AttachAddon implements ITerminalAddon , IAttachApi {\n  private _socket: WebSocket;\n  private _bidirectional: boolean;\n  private _disposables: IDisposable[] = [];\n\n  constructor(socket: WebSocket, options?: IAttachOptions) {\n    this._socket = socket;\n    // always set binary type to arraybuffer, we do not handle blobs\n    this._socket.binaryType = 'arraybuffer';\n    this._bidirectional = !(options && options.bidirectional === false);\n  }\n\n  public activate(terminal: Terminal): void {\n    this._disposables.push(\n      addSocketListener(this._socket, 'message', ev => {\n        const data: ArrayBuffer | string = ev.data;\n        terminal.write(typeof data === 'string' ? data : new Uint8Array(data));\n      })\n    );\n\n    if (this._bidirectional) {\n      this._disposables.push(terminal.onData(data => this._sendData(data)));\n      this._disposables.push(terminal.onBinary(data => this._sendBinary(data)));\n    }\n\n    this._disposables.push(addSocketListener(this._socket, 'close', () => this.dispose()));\n    this._disposables.push(addSocketListener(this._socket, 'error', () => this.dispose()));\n  }\n\n  public dispose(): void {\n    for (const d of this._disposables) {\n      d.dispose();\n    }\n  }\n\n  private _sendData(data: string): void {\n    if (!this._checkOpenSocket()) {\n      return;\n    }\n    this._socket.send(data);\n  }\n\n  private _sendBinary(data: string): void {\n    if (!this._checkOpenSocket()) {\n      return;\n    }\n    const buffer = new Uint8Array(data.length);\n    for (let i = 0; i < data.length; ++i) {\n      buffer[i] = data.charCodeAt(i) & 255;\n    }\n    this._socket.send(buffer);\n  }\n\n  private _checkOpenSocket(): boolean {\n    switch (this._socket.readyState) {\n      case WebSocket.OPEN:\n        return true;\n      case WebSocket.CONNECTING:\n        throw new Error('Attach addon was loaded before socket was open');\n      case WebSocket.CLOSING:\n        console.warn('Attach addon socket is closing');\n        return false;\n      case WebSocket.CLOSED:\n        throw new Error('Attach addon socket is closed');\n      default:\n        throw new Error('Unexpected socket state');\n    }\n  }\n}\n\nfunction addSocketListener<K extends keyof WebSocketEventMap>(socket: WebSocket, type: K, handler: (this: WebSocket, ev: WebSocketEventMap[K]) => any): IDisposable {\n  socket.addEventListener(type, handler);\n  return {\n    dispose: () => {\n      if (!handler) {\n        // Already disposed\n        return;\n      }\n      socket.removeEventListener(type, handler);\n    }\n  };\n}\n"],
  "mappings": ";;;AAcO,IAAMA,IAAN,MAAyD;EAK9D,YAAYC,GAAmBC,GAA0B;AAFzD,SAAQ,eAA8B,CAAC;AAGrC,SAAK,UAAUD,GAEf,KAAK,QAAQ,aAAa,eAC1B,KAAK,iBAAiB,EAAEC,KAAWA,EAAQ,kBAAkB;EAC/D;EAEO,SAASC,GAA0B;AACxC,SAAK,aAAa,KAChBC,EAAkB,KAAK,SAAS,WAAWC,OAAM;AAC/C,UAAMC,IAA6BD,EAAG;AACtCF,QAAS,MAAM,OAAOG,KAAS,WAAWA,IAAO,IAAI,WAAWA,CAAI,CAAC;IACvE,CAAC,CACH,GAEI,KAAK,mBACP,KAAK,aAAa,KAAKH,EAAS,OAAOG,OAAQ,KAAK,UAAUA,CAAI,CAAC,CAAC,GACpE,KAAK,aAAa,KAAKH,EAAS,SAASG,OAAQ,KAAK,YAAYA,CAAI,CAAC,CAAC,IAG1E,KAAK,aAAa,KAAKF,EAAkB,KAAK,SAAS,SAAS,MAAM,KAAK,QAAQ,CAAC,CAAC,GACrF,KAAK,aAAa,KAAKA,EAAkB,KAAK,SAAS,SAAS,MAAM,KAAK,QAAQ,CAAC,CAAC;EACvF;EAEO,UAAgB;AACrB,aAAWG,KAAK,KAAK,aACnBA,GAAE,QAAQ;EAEd;EAEQ,UAAUD,GAAoB;AAC/B,SAAK,iBAAiB,KAG3B,KAAK,QAAQ,KAAKA,CAAI;EACxB;EAEQ,YAAYA,GAAoB;AACtC,QAAI,CAAC,KAAK,iBAAiB,EACzB;AAEF,QAAME,IAAS,IAAI,WAAWF,EAAK,MAAM;AACzC,aAASG,IAAI,GAAGA,IAAIH,EAAK,QAAQ,EAAEG,EACjCD,GAAOC,CAAC,IAAIH,EAAK,WAAWG,CAAC,IAAI;AAEnC,SAAK,QAAQ,KAAKD,CAAM;EAC1B;EAEQ,mBAA4B;AAClC,YAAQ,KAAK,QAAQ,YAAY;MAC/B,KAAK,UAAU;AACb,eAAO;MACT,KAAK,UAAU;AACb,cAAM,IAAI,MAAM,gDAAgD;MAClE,KAAK,UAAU;AACb,eAAA,QAAQ,KAAK,gCAAgC,GACtC;MACT,KAAK,UAAU;AACb,cAAM,IAAI,MAAM,+BAA+B;MACjD;AACE,cAAM,IAAI,MAAM,yBAAyB;IAC7C;EACF;AACF;AAEA,SAASJ,EAAqDH,GAAmBS,GAASC,GAA0E;AAClK,SAAAV,EAAO,iBAAiBS,GAAMC,CAAO,GAC9B,EACL,SAAS,MAAM;AACRA,SAILV,EAAO,oBAAoBS,GAAMC,CAAO;EAC1C,EACF;AACF;",
  "names": ["AttachAddon", "socket", "options", "terminal", "addSocketListener", "ev", "data", "d", "buffer", "i", "type", "handler"]
}
